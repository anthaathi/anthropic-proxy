<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Log Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/renderjson@1.4.0/renderjson.js"></script>
    <style>
        /* Renderjson Styles */
        .renderjson {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .renderjson a {
            text-decoration: none;
            color: #6b7280;
        }

        .renderjson a:hover {
            color: #3b82f6;
        }

        .renderjson .disclosure {
            display: inline-block;
            width: 14px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }

        .renderjson .syntax {
            color: #6b7280;
            font-weight: bold;
        }

        .renderjson .string {
            color: #10b981;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .renderjson .number {
            color: #3b82f6;
        }

        .renderjson .boolean {
            color: #f59e0b;
        }

        .renderjson .key {
            color: #8b5cf6;
            font-weight: 500;
        }

        .renderjson .keyword {
            color: #ef4444;
        }

        .renderjson .object.syntax {
            color: #6b7280;
        }

        .renderjson .array.syntax {
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Request Log Viewer</h1>
            <p class="text-gray-600">Analyze and filter HTTP request/response logs in JSON Lines format</p>
        </div>

        <!-- File Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Load Log File</label>
                <input type="file" id="fileInput" accept=".log,.jsonl,.txt"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div class="text-sm text-gray-500">
                <p>Or paste log content directly:</p>
                <textarea id="pasteArea" rows="4"
                    class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    placeholder="Paste JSON Lines log content here..."></textarea>
                <button onclick="loadFromPaste()"
                    class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Load from Paste
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div id="filtersSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" id="searchFilter"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        placeholder="Search in logs...">
                </div>

                <!-- Direction -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Direction</label>
                    <select id="directionFilter"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All</option>
                        <option value="request">Request</option>
                        <option value="response">Response</option>
                    </select>
                </div>

                <!-- Provider -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Provider</label>
                    <select id="providerFilter"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Providers</option>
                    </select>
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="statusFilter"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All</option>
                        <option value="success">Success</option>
                        <option value="failure">Failure</option>
                    </select>
                </div>

                <!-- Model -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                    <select id="modelFilter"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Models</option>
                    </select>
                </div>

                <!-- Streaming -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Streaming</label>
                    <select id="streamingFilter"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All</option>
                        <option value="true">Streaming</option>
                        <option value="false">Non-streaming</option>
                    </select>
                </div>

                <!-- Attempt Number -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Attempt</label>
                    <select id="attemptFilter"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Attempts</option>
                    </select>
                </div>

                <!-- Request Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Request Type</label>
                    <select id="requestTypeFilter"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All</option>
                        <option value="benchmark">Benchmark</option>
                        <option value="client">Client API</option>
                    </select>
                </div>

                <!-- Clear Filters -->
                <div class="flex items-end">
                    <button onclick="clearFilters()"
                        class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                        Clear Filters
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div id="statsSection" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600">Total Entries</div>
                    <div id="statTotal" class="text-2xl font-bold text-blue-600">0</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600">Successful</div>
                    <div id="statSuccess" class="text-2xl font-bold text-green-600">0</div>
                </div>
                <div class="bg-red-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600">Failed</div>
                    <div id="statFailed" class="text-2xl font-bold text-red-600">0</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600">Avg Duration</div>
                    <div id="statDuration" class="text-2xl font-bold text-purple-600">0s</div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logsSection" class="hidden">
            <div class="mb-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">
                    Log Entries <span id="entryCount" class="text-gray-500 text-base">(0)</span>
                </h2>
                <button onclick="exportFiltered()"
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    Export Filtered
                </button>
            </div>
            <div id="logEntries" class="space-y-4">
                <!-- Log entries will be inserted here -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No logs loaded</h3>
            <p class="mt-1 text-sm text-gray-500">Upload a log file or paste content to get started</p>
        </div>
    </div>

    <script>
        let allLogs = [];
        let filteredLogs = [];

        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseAndDisplayLogs(e.target.result);
                };
                reader.readAsText(file);
            }
        });

        // Load from paste
        function loadFromPaste() {
            const content = document.getElementById('pasteArea').value;
            if (content.trim()) {
                parseAndDisplayLogs(content);
            }
        }

        // Parse logs
        function parseAndDisplayLogs(content) {
            const lines = content.trim().split('\n');
            allLogs = [];

            for (const line of lines) {
                if (line.trim()) {
                    try {
                        const log = JSON.parse(line);
                        allLogs.push(log);
                    } catch (e) {
                        console.error('Failed to parse line:', line, e);
                    }
                }
            }

            if (allLogs.length > 0) {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('filtersSection').classList.remove('hidden');
                document.getElementById('logsSection').classList.remove('hidden');

                populateFilterOptions();
                applyFilters();
            } else {
                alert('No valid log entries found in the file');
            }
        }

        // Populate filter dropdowns
        function populateFilterOptions() {
            const providers = new Set();
            const models = new Set();
            const attempts = new Set();

            allLogs.forEach(log => {
                if (log.provider) providers.add(log.provider);
                if (log.model) models.add(log.model);
                if (log.attempt_number) attempts.add(log.attempt_number);
            });

            // Populate providers
            const providerSelect = document.getElementById('providerFilter');
            providerSelect.innerHTML = '<option value="">All Providers</option>';
            [...providers].sort().forEach(p => {
                providerSelect.innerHTML += `<option value="${p}">${p}</option>`;
            });

            // Populate models
            const modelSelect = document.getElementById('modelFilter');
            modelSelect.innerHTML = '<option value="">All Models</option>';
            [...models].sort().forEach(m => {
                modelSelect.innerHTML += `<option value="${m}">${m}</option>`;
            });

            // Populate attempts
            const attemptSelect = document.getElementById('attemptFilter');
            attemptSelect.innerHTML = '<option value="">All Attempts</option>';
            [...attempts].sort((a, b) => a - b).forEach(a => {
                attemptSelect.innerHTML += `<option value="${a}">Attempt ${a}</option>`;
            });

            // Add filter listeners
            ['searchFilter', 'directionFilter', 'providerFilter', 'statusFilter',
             'modelFilter', 'streamingFilter', 'attemptFilter', 'requestTypeFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFilters);
            });
        }

        // Apply filters
        function applyFilters() {
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const direction = document.getElementById('directionFilter').value;
            const provider = document.getElementById('providerFilter').value;
            const status = document.getElementById('statusFilter').value;
            const model = document.getElementById('modelFilter').value;
            const streaming = document.getElementById('streamingFilter').value;
            const attempt = document.getElementById('attemptFilter').value;
            const requestType = document.getElementById('requestTypeFilter').value;

            filteredLogs = allLogs.filter(log => {
                // Search filter
                if (search && !JSON.stringify(log).toLowerCase().includes(search)) {
                    return false;
                }

                // Direction filter
                if (direction && log.direction !== direction) {
                    return false;
                }

                // Provider filter
                if (provider && log.provider !== provider) {
                    return false;
                }

                // Status filter
                if (status === 'success' && !log.success) {
                    return false;
                }
                if (status === 'failure' && log.success) {
                    return false;
                }

                // Model filter
                if (model && log.model !== model) {
                    return false;
                }

                // Streaming filter
                if (streaming && log.is_streaming !== (streaming === 'true')) {
                    return false;
                }

                // Attempt filter
                if (attempt && log.attempt_number !== parseInt(attempt)) {
                    return false;
                }

                // Request type filter (benchmark vs client API)
                if (requestType === 'benchmark' && log.attempt_number !== 0) {
                    return false;
                }
                if (requestType === 'client' && log.attempt_number === 0) {
                    return false;
                }

                return true;
            });

            displayLogs();
            updateStats();
        }

        // Display logs
        function displayLogs() {
            const container = document.getElementById('logEntries');
            container.innerHTML = '';

            document.getElementById('entryCount').textContent = `(${filteredLogs.length})`;

            filteredLogs.forEach((log, index) => {
                const entry = createLogEntry(log, index);
                container.appendChild(entry);
            });
        }

        // Create log entry HTML
        function createLogEntry(log, index) {
            const div = document.createElement('div');
            const isRequest = log.direction === 'request';
            const isSuccess = log.success;

            const bgColor = isRequest ? 'bg-blue-50' : (isSuccess ? 'bg-green-50' : 'bg-red-50');
            const borderColor = isRequest ? 'border-blue-200' : (isSuccess ? 'border-green-200' : 'border-red-200');

            div.className = `${bgColor} border ${borderColor} rounded-lg p-4`;

            const isBenchmark = log.attempt_number === 0;
            const providerType = log.path && log.path.includes('/chat/completions') ? 'OpenAI' : 'Anthropic';

            let html = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${isRequest ? 'bg-blue-200 text-blue-800' : (isSuccess ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800')}">
                            ${log.direction.toUpperCase()}
                        </span>
                        <span class="text-sm font-medium text-gray-700">${log.provider}</span>
                        ${log.model ? `<span class="text-xs text-gray-500">${log.model}</span>` : ''}
                        ${isBenchmark ? `<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">BENCHMARK</span>` : ''}
                        ${log.attempt_number && !isBenchmark ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">Attempt ${log.attempt_number}</span>` : ''}
                        ${log.is_streaming ? `<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">STREAMING</span>` : ''}
                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">${providerType} API</span>
                    </div>
                    <span class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString()}</span>
                </div>

                ${log.path ? `
                    <div class="mb-3 text-sm bg-gray-50 rounded p-2">
                        <span class="font-semibold text-gray-700">URL:</span>
                        <code class="text-xs text-blue-600 break-all">${log.path}</code>
                    </div>
                ` : ''}

                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3 text-sm">
                    ${log.method ? `<div><span class="font-semibold">Method:</span> ${log.method}</div>` : ''}
                    ${log.status_code ? `<div><span class="font-semibold">Status:</span> ${log.status_code}</div>` : ''}
                    ${log.duration_seconds ? `<div><span class="font-semibold">Duration:</span> ${log.duration_seconds.toFixed(3)}s</div>` : ''}
                    ${log.token_count ? `<div><span class="font-semibold">Tokens:</span> ${log.token_count}</div>` : ''}
                    ${log.error ? `<div class="col-span-2 md:col-span-4"><span class="font-semibold text-red-600">Error:</span> <span class="text-red-600">${log.error}</span></div>` : ''}
                </div>

                ${log.headers ? `
                    <details class="mb-2">
                        <summary class="cursor-pointer text-sm font-semibold text-gray-700 hover:text-gray-900">Headers (${Object.keys(log.headers).length})</summary>
                        <div class="mt-2 bg-white rounded p-3 overflow-x-auto">
                            <div class="mb-2 flex gap-2">
                                <button onclick="expandAll('headers-${index}')" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Expand All</button>
                                <button onclick="collapseAll('headers-${index}')" class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Collapse All</button>
                            </div>
                            <div class="json-tree" id="headers-${index}"></div>
                        </div>
                    </details>
                ` : ''}

                ${log.body ? `
                    <details>
                        <summary class="cursor-pointer text-sm font-semibold text-gray-700 hover:text-gray-900">Body</summary>
                        <div class="mt-2 bg-white rounded p-3 overflow-x-auto max-h-96">
                            <div class="mb-2 flex gap-2">
                                <button onclick="expandAll('body-${index}')" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Expand All</button>
                                <button onclick="collapseAll('body-${index}')" class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Collapse All</button>
                                <button onclick="copyJson('body-${index}')" class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">Copy JSON</button>
                            </div>
                            <div class="json-tree" id="body-${index}"></div>
                        </div>
                    </details>
                ` : ''}
            `;

            div.innerHTML = html;

            // Render JSON trees after DOM is inserted
            setTimeout(() => {
                if (log.headers) {
                    const headersContainer = document.getElementById(`headers-${index}`);
                    if (headersContainer) {
                        renderJsonTree(log.headers, headersContainer);
                    }
                }
                if (log.body) {
                    const bodyContainer = document.getElementById(`body-${index}`);
                    if (bodyContainer) {
                        try {
                            const parsed = JSON.parse(log.body);
                            renderJsonTree(parsed, bodyContainer);
                        } catch (e) {
                            bodyContainer.textContent = log.body;
                            bodyContainer.classList.add('whitespace-pre-wrap');
                        }
                    }
                }
            }, 0);

            return div;
        }

        // Render JSON using renderjson library
        function renderJsonTree(data, container) {
            container.innerHTML = '';
            // Configure renderjson
            renderjson.set_show_to_level(1); // Start with first level expanded
            renderjson.set_max_string_length(100); // Truncate long strings
            renderjson.set_icons('▶', '▼'); // Set expand/collapse icons

            const jsonElement = renderjson(data);
            container.appendChild(jsonElement);
        }

        // Expand all JSON nodes in a container
        function expandAll(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Find all collapsed disclosure triangles
            const disclosures = container.querySelectorAll('.disclosure');
            disclosures.forEach(disclosure => {
                // Check if it's collapsed (has the expand icon)
                if (disclosure.textContent === '▶') {
                    disclosure.click();
                }
            });
        }

        // Collapse all JSON nodes in a container
        function collapseAll(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Find all expanded disclosure triangles
            const disclosures = container.querySelectorAll('.disclosure');
            disclosures.forEach(disclosure => {
                // Check if it's expanded (has the collapse icon)
                if (disclosure.textContent === '▼') {
                    disclosure.click();
                }
            });
        }

        // Copy JSON to clipboard
        function copyJson(containerId) {
            // Find the corresponding log entry
            const index = parseInt(containerId.split('-')[1]);
            const log = filteredLogs[index];

            if (log && log.body) {
                try {
                    const parsed = JSON.parse(log.body);
                    const formatted = JSON.stringify(parsed, null, 2);
                    navigator.clipboard.writeText(formatted).then(() => {
                        // Show success feedback
                        const btn = event.target;
                        const originalText = btn.textContent;
                        btn.textContent = 'Copied!';
                        btn.classList.remove('bg-green-100', 'text-green-700');
                        btn.classList.add('bg-green-600', 'text-white');
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.classList.add('bg-green-100', 'text-green-700');
                            btn.classList.remove('bg-green-600', 'text-white');
                        }, 1500);
                    }).catch(err => {
                        alert('Failed to copy to clipboard');
                    });
                } catch (e) {
                    navigator.clipboard.writeText(log.body);
                }
            }
        }

        // Update stats
        function updateStats() {
            const total = filteredLogs.length;
            const successful = filteredLogs.filter(l => l.success).length;
            const failed = total - successful;

            const durations = filteredLogs.filter(l => l.duration_seconds).map(l => l.duration_seconds);
            const avgDuration = durations.length > 0
                ? (durations.reduce((a, b) => a + b, 0) / durations.length).toFixed(3)
                : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statSuccess').textContent = successful;
            document.getElementById('statFailed').textContent = failed;
            document.getElementById('statDuration').textContent = avgDuration + 's';
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('directionFilter').value = '';
            document.getElementById('providerFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('modelFilter').value = '';
            document.getElementById('streamingFilter').value = '';
            document.getElementById('attemptFilter').value = '';
            document.getElementById('requestTypeFilter').value = '';
            applyFilters();
        }

        // Export filtered logs
        function exportFiltered() {
            const dataStr = filteredLogs.map(log => JSON.stringify(log)).join('\n');
            const dataBlob = new Blob([dataStr], { type: 'text/plain' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `filtered-logs-${new Date().toISOString()}.jsonl`;
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
